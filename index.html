<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">
		<title>Guliveer/UZ - Repo Viewer</title>
		<style>
			* {
				font-family: 'Fira Code', monospace;
			}

			body {
				line-height: 1.6;
				margin: 0;
				padding: 0;
				color: #333;
				background: #f4f4f9;
			}

			header {
				background: #007bff;
				color: #fff;
				padding: 10px 20px;
				text-align: center;
			}

			header h1 {
				margin: 0;
			}

			main {
				padding: 20px;
			}

			section {
				margin-bottom: 20px;
				padding: 15px;
				background: #fff;
				border: 1px solid #ddd;
				border-radius: 5px;
			}

			footer {
				text-align: center;
				padding: 10px;
				background: #333;
				color: #fff;
			}

			ul {
				list-style-type: none;
				padding: 0;
			}

			li {
				padding: 5px;
				border-bottom: 1px solid #ddd;
			}

			a {
				text-decoration: none;
				color: #007bff;
				cursor: pointer;
			}

			a:visited {
				color: #007bff;
			}

			.main-btn {
				margin-bottom: 10px;
			}

			.download-btn,
			.back-btn {
				background: #28a745;
				color: #fff;
				padding: 5px 10px;
				border: none;
				border-radius: 3px;
				cursor: pointer;
				font-size: 0.9em;
			}

			.back-btn {
				background: #007bff;
			}

			.download-btn:hover {
				background: #218838;
			}

			.back-btn:hover {
				background: #0056b3;
			}
		</style>
	</head>

	<body>
		<header>
			<h1>GitHub - Guliveer/UZ</h1>
			<p>Explore files and learn more about this repo</p>
		</header>
		<main>
			<section id="project-info">
				<h2>About This Project</h2>
				<div id="readme-content">Loading...</div>
			</section>
			<section id="file-list">
				<h2>Repository Files</h2>
				<label>~/</label>
				<ul>
					<!-- Dynamic list of files will go here -->
				</ul>
			</section>
		</main>
		<footer>
			<p>Powered by <a href="https://github.com">GitHub Pages</a></p>
		</footer>
	</body>

	<script>
		const username = "Guliveer"; // Twój login na GitHubie
		const repo = "UZ"; // Nazwa repozytorium
		const cacheKey = `repoCache_${username}_${repo}`;
		let repoCache = JSON.parse(localStorage.getItem(cacheKey)) || {}; // Cache w LocalStorage
		let currentPath = ""; // Aktualna ścieżka
		let token = null; // Token API

		// Wczytaj token z pliku `token.js`
		fetch('./token.js')
			.then(response => {
				if (response.ok) return response.text();
				throw new Error('Token file not found');
			})
			.then(script => {
				eval(script); // Wykonaj kod, aby ustawić `window.GITHUB_API_TOKEN`
				token = window.GITHUB_API_TOKEN;
				if (!token) throw new Error('Token not loaded');
				console.log("Token loaded successfully");
			})
			.catch(error => console.error("Error loading token:", error));

		// Funkcja do fetch z autoryzacją
		function fetchWithAuth(url) {
			if (!token) {
				console.error("Token not loaded");
				return Promise.reject("Token not loaded");
			}
			return fetch(url, {
				headers: {
					Authorization: `token ${token}`,
					Accept: "application/vnd.github.v3+json"
				}
			});
		}

		// Inicjalizacja po załadowaniu DOM
		document.addEventListener("DOMContentLoaded", () => {
			loadReadme(); // Wczytaj README.md
			loadFiles(currentPath); // Wczytaj pliki repozytorium
		});

		// Wczytaj README.md
		function loadReadme() {
			fetchWithAuth(`https://api.github.com/repos/${username}/${repo}/readme`)
				.then(response => response.text())
				.then(html => {
					document.getElementById("readme-content").innerHTML = html;
				})
				.catch(() => {
					document.getElementById("readme-content").innerText =
						"README.md file not found in the repository.";
				});
		}

		// Wczytaj pliki i foldery
		function loadFiles(path) {
			const cachedData = repoCache[path];

			if (cachedData) {
				validateCacheAndRender(cachedData, path);
			} else {
				fetchAndCacheFiles(path);
			}
		}

		// Sprawdź cache i zaktualizuj w razie potrzeby
		function validateCacheAndRender(cachedData, path) {
			fetchWithAuth(`https://api.github.com/repos/${username}/${repo}/contents/${path}`)
				.then(response => response.json())
				.then(files => {
					if (files.sha !== cachedData.sha) {
						// Jeśli SHA różne, zaktualizuj cache
						repoCache[path] = { sha: files.sha, data: files };
						localStorage.setItem(cacheKey, JSON.stringify(repoCache));
						renderFiles(files, path);
					} else {
						// Jeśli cache aktualne, użyj go
						renderFiles(cachedData.data, path);
					}
				})
				.catch(() => {
					// Jeśli API niedostępne, użyj cache
					renderFiles(cachedData.data, path);
				});
		}

		// Pobierz pliki z API i zapisz do cache
		function fetchAndCacheFiles(path) {
			fetchWithAuth(`https://api.github.com/repos/${username}/${repo}/contents/${path}`)
				.then(response => response.json())
				.then(files => {
					// Zapisz w cache
					repoCache[path] = { sha: files.sha, data: files };
					localStorage.setItem(cacheKey, JSON.stringify(repoCache));
					renderFiles(files, path);
				})
				.catch(() => {
					const fileList = document.querySelector("#file-list ul");
					fileList.innerHTML = "<li>Error loading files</li>";
				});
		}

		// Renderuj pliki w interfejsie
		function renderFiles(files, path) {
			const fileList = document.querySelector("#file-list ul");
			fileList.innerHTML = "";
			document.querySelector("#file-list label").textContent = `~/${path}`;

			// Dodaj przycisk "Go Back" jeśli nie w root
			if (path) {
				const backBtn = document.createElement("button");
				backBtn.textContent = "Go Back";
				backBtn.className = "back-btn main-btn";
				backBtn.onclick = () => {
					const parentPath = path.split("/").slice(0, -1).join("/");
					loadFiles(parentPath);
				};
				fileList.appendChild(backBtn);
			}

			// Dodaj przycisk "Download current dir"
			const downloadBtn = document.createElement("button");
			downloadBtn.textContent = "Download current dir";
			downloadBtn.className = "download-btn main-btn";
			downloadBtn.onclick = () => {
				const folderUrl = `https://github.com/${username}/${repo}/tree/main/${path}`;
				window.open(`https://download-directory.github.io/?url=${folderUrl}`);
			};
			fileList.appendChild(downloadBtn);

			// Renderuj pliki i foldery
			files.forEach(file => {
				const li = document.createElement("li");
				const link = document.createElement("a");
				link.textContent = file.name;

				if (file.type === "dir") {
					// Folder: kliknięcie wczytuje zawartość
					link.onclick = () => loadFiles(file.path);
				} else {
					// Plik: kliknięcie otwiera w nowej karcie
					link.href = file.html_url;
					link.target = "_blank";
				}

				li.appendChild(link);
				fileList.appendChild(li);
			});
		}
	</script>

</html>